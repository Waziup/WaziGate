pipeline {
  agent any
  environment {
    ISO = 'image_2021-10-31-WaziGate.zip'
  }
  stages {
    stage('Prepare') {
      steps {
        copyArtifacts projectName: 'compiling/WaziGate_ISO', selector: specific('47')
        sh 'unzip $ISO'
        sh 'sudo kpartx -av 2021-10-31-WaziGate.img'
        sh 'sudo mount /dev/mapper/loop1p2 /mnt/WaziGate_nightly'
        sh 'sudo mount /dev/mapper/loop1p1 /mnt/WaziGate_nightly/boot'
        sh 'sudo echo "console=serial0,115200 console=tty1 root=/dev/nfs nfsroot=172.16.11.191:/mnt/MyISO,vers=3 rw ip=dhcp rootwait elevator=deadline" > /mnt/WaziGate_nightly/boot/cmdline.txt`'
        sh 'sudo echo "" > /mnt/WaziGate_nightly/etc/fstab'
      }
    }
    stage('Run') {
      steps {
        sh 'ssh pi@$WAZIGATE_URL "echo loragateway | sudo shutdown -r now"'
      }
    }
  }
}
